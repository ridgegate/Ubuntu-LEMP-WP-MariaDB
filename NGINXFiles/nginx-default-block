# Upstream to abstract backend connection(s) for php
upstream php {
        server unix:/tmp/php-cgi.socket;
        server 127.0.0.1:9000;
}

server {
	listen 80;
	root /var/www/html/domain.com;
	index index.php index.html index.htm;
	server_name domain.com www.domain.com;
	charset UTF-8;

	location = /favicon.ico {
                log_not_found off;
                access_log off;
        }

        location = /robots.txt {
                allow all;
                log_not_found off;
                access_log off;
        }


	include /var/www/html/domain.com/nginx.conf;

	location / {
		try_files $uri $uri/ /index.php?$args;
	}

	location ~ /.well-known {
		allow all;
	}

	location ~ \.php$ {
		try_files $uri =404;
		include fastcgi_params;
		fastcgi_pass unix:/run/php/php7.4-fpm.sock;
	}

	location ~* \.(js|css|png|jpg|jpeg|gif|ico|eot|otf|ttf|woff|svg|svgz|atom|pdf|doc)$ {
		valid_referers none blocked ~.google. ~.bing. ~.yahoo domain.com *.domain.com publicip;
		access_log off; 
		log_not_found off; 
		expires 30d;
		if ($invalid_referer) { return 404; }
	}

	# Deny access to the nginx.conf file generated by W3TC
	location = /nginx.conf {
		deny all;
	}
}
