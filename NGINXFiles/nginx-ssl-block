server {
  listen 80;
  listen [::]:80;

  server_name domain.com www.domain.com;
  return 302 https://$server_name$request_uri;
}

server {
  listen 443 ssl http2;
  listen [::]:443 ssl http2;
  ssl on;
  ssl_certificate /etc/ssl/certs/domain.com.pem;
  ssl_certificate_key /etc/ssl/private/domain.com.pem;
  ssl_client_certificate /etc/ssl/certs/origin-pull-ca.pem;
  ssl_verify_client on;
   
  server_name domain.com www.domain.com;
  
  root /var/www/html/domain.com;
  index index.php index.html index.htm;
  charset UTF-8;  
  
  location / {
    try_files $uri $uri/ /index.php$is_args$args;
  }
  
  location ~ /.well-known {
    allow all;
  }
  
  location ~ \.php$ {
   try_files $uri =404;
   fastcgi_split_path_info ^(.+\.php)(/.+)$;
   fastcgi_pass unix:/run/php/php7.3-fpm.sock;
   fastcgi_index index.php;
   include fastcgi.conf;
  }
  
  location ~* \.(js|css|png|jpg|jpeg|gif|ico|eot|otf|ttf|woff|svg)$ {
   valid_referers none blocked ~.google. ~.bing. ~.yahoo domain.com *.domain.com publicip;
   access_log off; 
   log_not_found off; 
   expires 30d;
   if ($invalid_referer) { return 404; }
  }
  
  include global/restrictions.conf;

}
