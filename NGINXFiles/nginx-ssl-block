server {
  listen 80;
  listen [::]:80;

  server_name domain.com www.domain.com;
  return 302 https://$server_name$request_uri;
}

server {
  server_name domain.com www.domain.com;
  root /var/www/html/domain.com;
  index index.php index.html index.htm;
  charset UTF-8;
  
  #For W3 Total Cache use
  include /var/www/html/domain.com/nginx.conf;
  include /etc/nginx/restrictions/serverblock_restrictions.conf;
    
  listen 443 ssl http2;
  listen [::]:443 ssl http2;
  ssl_protocols TLSv1.1 TLSv1.2 TLSv1.3;
  ssl_prefer_server_ciphers on;
  ssl_session_timeout 20m;
  ssl_ciphers 'EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH';
  ssl_certificate         /etc/ssl/private/domain.com_cert.pem;
  ssl_certificate_key     /etc/ssl/private/domain.com_key.pem;
  ssl_client_certificate /etc/ssl/private/cloudflareoa_cert.pem;
  ssl_verify_client on;

  error_page 404 444 /404.html;
  error_page 500 502 503 504 /50x.html;

	location / {
		#try_files $uri $uri/ /index.php?$args;
		try_files /wp-content/w3tc/pgcache/$cache_uri/_index.html $uri $uri/ /index.php?q=$uri&$args;
	}

	location ~ /.well-known {
		allow all;
	}

	location ~ \.php$ {
		try_files $uri =404;
		fastcgi_split_path_info ^(.+\.php)(/.+)$;
		include fastcgi_params;		
		fastcgi_pass unix:/var/run/php/php7.4-fpm.sock;
		fastcgi_read_timeout 300;
	}

	location ~* \.(js|css|png|jpg|jpeg|gif|ico|eot|otf|ttf|woff|svg|svgz|atom|pdf|doc)$ {
		valid_referers none blocked ~.google. ~.bing. ~.yahoo ridgegatetools.com *.ridgegatetools.com 134.122.42.39;
		access_log off; 
		log_not_found off; 
		expires 30d;
		if ($invalid_referer) { return 404; }
	}

	# Deny access to the nginx.conf file generated by W3TC
	location = /*.conf {
		deny all;
	}
}



