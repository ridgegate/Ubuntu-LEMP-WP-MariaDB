server {
  listen 80;
  listen [::]:80;

  server_name domain.com www.domain.com;
  return 302 https://$server_name$request_uri;
}

server {
  server_name domain.com www.domain.com;
  root /var/www/html/domain.com;
  index index.php index.html index.htm;
  
  #For W3 Total Cache use
  include /var/www/html/domain.com/nginx.conf;

  listen 443 ssl http2;
  listen [::]:443 ssl http2;
  ssl_protocols TLSv1.1 TLSv1.2 TLSv1.3;
  ssl_prefer_server_ciphers on;
  ssl_session_timeout 20m;
  ssl_ciphers 'EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH';
  ssl_certificate         /etc/ssl/private/domain.com_cert.pem;
  ssl_certificate_key     /etc/ssl/private/domain.com_key.pem;
  ssl_client_certificate /etc/ssl/private/cloudflareoa_cert.pem;
  ssl_verify_client on;

  error_page 404 444 /404.html;
  error_page 500 502 503 504 /50x.html;


  location / {
    try_files $uri $uri/ /index.php$is_args$args;
  }

  # Pass all .php files onto a php-fpm or php-cgi server
  location ~ .php$ {
        try_files $uri =404;
        include fastcgi_params;
        fastcgi_pass unix:/var/run/php5-fpm.sock;
    }
  
  location ~* \.(js|css|png|jpg|jpeg|gif|ico|eot|otf|ttf|woff|svg|svgz|atom|pdf|doc)$ {
   valid_referers none blocked ~.google. ~.bing. ~.yahoo domain.com *.domain.com publicip;
   access_log off; 
   log_not_found off; 
   expires max;
   if ($invalid_referer) { return 404; }
  }

}
